from pathlib import Path
from datetime import datetime
import pandas as pd
import plotly.express as px
import plotly.io as pio

# ========= CONFIG =========
INPUT_CSV = Path("Pulse result - XCap (LP's) - Numbers.csv")
OUTPUT_HTML = Path("pulse_report_styled.html")

BRAND_NAME = "MXI2 Tracking"
ACCENT = "#ff2d2d"          # vermelho principal
ACCENT_DARK = "#c81f1f"     # vermelho mais escuro
BG_TOP = "#0b1220"          # topo (nav)
BG_PAGE_1 = "#0b1220"       # início do gradiente
BG_PAGE_2 = "#0f1b2e"       # meio do gradiente
CARD_BG = "rgba(255,255,255,0.06)"
BORDER = "rgba(255,255,255,0.10)"
TEXT = "rgba(255,255,255,0.92)"
TEXT_MUTED = "rgba(255,255,255,0.70)"
CHART_BG = "rgba(255,255,255,0.02)"

# ========= LOAD =========
df = pd.read_csv(INPUT_CSV)

timestamp_col = next((c for c in df.columns if c.lower().startswith("timestamp")), df.columns[0])
df[timestamp_col] = pd.to_datetime(df[timestamp_col], errors="coerce")

comment_col = next((c for c in df.columns if "optional" in c.lower() or "comment" in c.lower()), None)

question_cols = [c for c in df.columns if c not in {timestamp_col, comment_col}]
for c in question_cols:
    df[c] = pd.to_numeric(df[c], errors="coerce")

n = len(df)
overall_mean = float(df[question_cols].stack().mean()) if question_cols else float("nan")

summary = pd.DataFrame({
    "Question": question_cols,
    "Mean": [df[c].mean() for c in question_cols],
    "Median": [df[c].median() for c in question_cols],
    "Min": [df[c].min() for c in question_cols],
    "Max": [df[c].max() for c in question_cols],
}).sort_values("Mean", ascending=False)

best_q = summary.iloc[0]["Question"] if len(summary) else "-"
best_mean = float(summary.iloc[0]["Mean"]) if len(summary) else float("nan")
worst_q = summary.iloc[-1]["Question"] if len(summary) else "-"
worst_mean = float(summary.iloc[-1]["Mean"]) if len(summary) else float("nan")

date_min = df[timestamp_col].min()
date_max = df[timestamp_col].max()

# ========= PLOTLY THEME =========
template = dict(
    layout=dict(
        paper_bgcolor="rgba(0,0,0,0)",
        plot_bgcolor=CHART_BG,
        font=dict(family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial", color=TEXT),
        title=dict(font=dict(size=14, color=TEXT)),
        margin=dict(l=20, r=20, t=50, b=20),
        xaxis=dict(
            gridcolor="rgba(255,255,255,0.06)",
            zerolinecolor="rgba(255,255,255,0.10)",
            tickfont=dict(color=TEXT_MUTED),
            titlefont=dict(color=TEXT_MUTED),
        ),
        yaxis=dict(
            gridcolor="rgba(255,255,255,0.06)",
            zerolinecolor="rgba(255,255,255,0.10)",
            tickfont=dict(color=TEXT_MUTED),
            titlefont=dict(color=TEXT_MUTED),
        ),
        legend=dict(font=dict(color=TEXT_MUTED)),
    )
)

def dist_chart(col_name: str):
    counts = (
        df[col_name]
        .value_counts(dropna=False)
        .reindex([1, 2, 3, 4, 5], fill_value=0)
        .rename_axis("Score")
        .reset_index(name="Responses")
    )
    fig = px.bar(
        counts,
        x="Score",
        y="Responses",
        title=col_name,
        text="Responses",
    )
    fig.update_layout(
        template=template,
        xaxis=dict(dtick=1, title="Score (1–5)"),
        yaxis=dict(title="Responses"),
    )
    fig.update_traces(
        marker_color=ACCENT,
        marker_line_color="rgba(255,255,255,0.12)",
        marker_line_width=1,
        textfont_color=TEXT,
        hovertemplate="Score=%{x}<br>Responses=%{y}<extra></extra>",
    )
    return fig

figs_html = "\n".join(
    [pio.to_html(dist_chart(c), include_plotlyjs=False, full_html=False) for c in question_cols]
)

# Comments
comments_html = ""
if comment_col:
    comments = df[comment_col].dropna().astype(str).str.strip()
    comments = comments[comments != ""]
    if len(comments):
        items = "\n".join([f"<div class='comment'>“{c}”</div>" for c in comments])
        comments_html = f"""
        <section class="panel">
          <div class="panel-header">
            <div class="panel-title">Open-ended comments</div>
            <div class="panel-subtitle">{len(comments)} comment(s)</div>
          </div>
          <div class="panel-body comments-grid">
            {items}
          </div>
        </section>
        """

# Summary table HTML (custom to fit dark UI)
def fmt(x):
    try:
        return f"{float(x):.2f}"
    except Exception:
        return str(x)

rows = []
for _, r in summary.iterrows():
    rows.append(f"""
      <tr>
        <td class="q">{r['Question']}</td>
        <td>{fmt(r['Mean'])}</td>
        <td>{fmt(r['Median'])}</td>
        <td>{fmt(r['Min'])}</td>
        <td>{fmt(r['Max'])}</td>
      </tr>
    """)

summary_table_html = f"""
<div class="table-wrap">
  <table class="table">
    <thead>
      <tr>
        <th>Question</th>
        <th>Mean</th>
        <th>Median</th>
        <th>Min</th>
        <th>Max</th>
      </tr>
    </thead>
    <tbody>
      {''.join(rows)}
    </tbody>
  </table>
</div>
"""

date_range_str = ""
if pd.notna(date_min) and pd.notna(date_max):
    date_range_str = f"{date_min.strftime('%Y-%m-%d')} → {date_max.strftime('%Y-%m-%d')}"

# ========= HTML =========
html = f"""
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{BRAND_NAME} · Pulse Survey</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    :root {{
      --accent: {ACCENT};
      --accent-dark: {ACCENT_DARK};
      --bg-top: {BG_TOP};
      --bg-1: {BG_PAGE_1};
      --bg-2: {BG_PAGE_2};
      --card: {CARD_BG};
      --border: {BORDER};
      --text: {TEXT};
      --muted: {TEXT_MUTED};
      --shadow: 0 18px 55px rgba(0,0,0,0.45);
      --shadow-soft: 0 10px 28px rgba(0,0,0,0.35);
      --radius: 18px;
    }}

    * {{ box-sizing: border-box; }}
    body {{
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 450px at 20% 0%, rgba(255,45,45,0.22), transparent 55%),
        radial-gradient(900px 450px at 80% 0%, rgba(255,45,45,0.12), transparent 55%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 55%, #0a1220 100%);
      min-height: 100vh;
    }}

    .nav {{
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(10,15,25,0.92), rgba(10,15,25,0.75));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }}

    .nav-inner {{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }}

    .brand {{
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }}

    .brand-dot {{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(255,45,45,0.18);
    }}

    .nav-links {{
      display: flex;
      gap: 14px;
      font-size: 13px;
      color: var(--muted);
    }}

    .nav-links span {{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: default;
    }}

    .nav-links .active {{
      color: var(--text);
      border-color: rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }}

    .container {{
      max-width: 1180px;
      margin: 0 auto;
      padding: 26px 18px 46px;
    }}

    .hero {{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      border-radius: calc(var(--radius) + 6px);
      padding: 22px 22px;
      box-shadow: var(--shadow-soft);
    }}

    .hero-title {{
      font-size: 28px;
      font-weight: 750;
      margin: 0 0 6px;
    }}

    .hero-sub {{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }}

    .meta-row {{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
    }}

    .pill {{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
    }}

    .pill .badge {{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.35);
    }}

    .grid {{
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 16px;
    }}

    .kpi {{
      grid-column: span 3;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px 14px;
      box-shadow: var(--shadow-soft);
    }}

    .kpi .label {{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 10px;
    }}

    .kpi .value {{
      font-size: 28px;
      font-weight: 750;
      letter-spacing: -0.4px;
    }}

    .kpi .hint {{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }}

    .kpi .accent {{
      color: var(--accent);
    }}

    .panel {{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }}

    .panel-header {{
      padding: 14px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }}

    .panel-title {{
      font-weight: 700;
      font-size: 14px;
    }}

    .panel-subtitle {{
      color: var(--muted);
      font-size: 12px;
    }}

    .panel-body {{
      padding: 12px 12px 14px;
    }}

    .span-12 {{ grid-column: span 12; }}
    .span-8 {{ grid-column: span 8; }}
    .span-4 {{ grid-column: span 4; }}

    .table {{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }}

    .table th {{
      text-align: left;
      color: var(--muted);
      font-weight: 600;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.02);
    }}

    .table td {{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.88);
    }}

    .table td.q {{
      max-width: 520px;
    }}

    .table tr:hover td {{
      background: rgba(255,255,255,0.03);
    }}

    .charts-grid {{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }}

    .chart-card {{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      border-radius: 16px;
      padding: 10px 10px 0;
      overflow: hidden;
    }}

    .comments-grid {{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }}

    .comment {{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      border-radius: 14px;
      padding: 12px 12px;
      color: rgba(255,255,255,0.86);
      line-height: 1.5;
    }}

    .footer {{
      margin-top: 18px;
      color: rgba(255,255,255,0.45);
      font-size: 12px;
      text-align: center;
    }}

    @media (max-width: 980px) {{
      .kpi {{ grid-column: span 6; }}
      .charts-grid {{ grid-template-columns: 1fr; }}
      .comments-grid {{ grid-template-columns: 1fr; }}
      .span-8, .span-4 {{ grid-column: span 12; }}
    }}
  </style>
</head>

<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <span class="brand-dot"></span>
        <span>{BRAND_NAME}</span>
      </div>
      <div class="nav-links">
        <span class="active">Overview</span>
        <span>Watchlist</span>
        <span>Exposure</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="hero">
      <div class="hero-title">LP Pulse Survey</div>
      <p class="hero-sub">A consolidated snapshot of sentiment and feedback. Designed for quick scanning and executive review.</p>
      <div class="meta-row">
        <span class="pill"><span class="badge"></span>Generated: {datetime.now().strftime("%Y-%m-%d %H:%M")}</span>
        <span class="pill"><span class="badge"></span>Responses: {n}</span>
        <span class="pill"><span class="badge"></span>Date range: {date_range_str or "-"}</span>
      </div>
    </div>

    <div class="grid">
      <div class="kpi">
        <div class="label">Overall mean (1–5)</div>
        <div class="value">{overall_mean:.2f}</div>
        <div class="hint">Average across all questions and respondents.</div>
      </div>

      <div class="kpi">
        <div class="label">Best question</div>
        <div class="value">{best_mean:.2f}</div>
        <div class="hint">{best_q}</div>
      </div>

      <div class="kpi">
        <div class="label">Lowest question</div>
        <div class="value">{worst_mean:.2f}</div>
        <div class="hint">{worst_q}</div>
      </div>

      <div class="kpi">
        <div class="label">Responses</div>
        <div class="value">{n}</div>
        <div class="hint">Small sample: interpret changes carefully.</div>
      </div>

      <section class="panel span-12">
        <div class="panel-header">
          <div class="panel-title">Summary by question</div>
          <div class="panel-subtitle">Mean/median/min/max</div>
        </div>
        <div class="panel-body">
          {summary_table_html}
        </div>
      </section>

      <section class="panel span-12">
        <div class="panel-header">
          <div class="panel-title">Distributions</div>
          <div class="panel-subtitle">Counts by score (1–5)</div>
        </div>
        <div class="panel-body">
          <div class="charts-grid">
            {"".join([f"<div class='chart-card'>{pio.to_html(dist_chart(c), include_plotlyjs=False, full_html=False)}</div>" for c in question_cols])}
          </div>
        </div>
      </section>

      {comments_html}
    </div>

    <div class="footer">Internal report · {BRAND_NAME}</div>
  </div>
</body>
</html>
"""

OUTPUT_HTML.write_text(html, encoding="utf-8")
print(f"Saved: {OUTPUT_HTML.resolve()}")
